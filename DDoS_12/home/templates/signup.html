{% extends 'index.html' %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>signup</title>      
</head>
<body>

{% block loader %}{% endblock %}

{% block content %}

<style>
  .fade-in {
    opacity: 0;
    transform: translateY(20px);
    animation: fadeInMoveUp 0.6s ease-out forwards;
    position: relative;
  }

  @keyframes fadeInMoveUp {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  #location-info {
    position: absolute;
    top: 50px;
    left: 450px;
    width: 200px;
    min-height: 120px;
    white-space: pre-line;
    font-size: 0.95rem;
    font-family: monospace;
    color: white;
    z-index: 10;
  }

  #cursor {
    animation: blink 0.8s infinite;
  }

  @keyframes blink {
    0%, 50%, 100% { opacity: 1; }
    25%, 75% { opacity: 0; }
  }

  @media (max-width: 768px) {
    #location-info {
      position: static !important;
      margin-top: 2rem;
      margin-left: 0;
      width: 100%;
      text-align: left;
    }
    .fade-in {
      flex-direction: column !important;
      align-items: flex-start !important;
    }
  }
</style>

<div class="fade-in">

  <h1 class="fst-italic lh-1 mb-4">SignUP</h1>

  <form action="signup" method="post">
    {% csrf_token %}
    <div id="stepEmail">
      <div class="row input-group-newsletter">
        <div class="col">

          <!-- First & Last Name -->
          <div class="d-flex gap-2 mb-3">
            <div class="flex-fill">
              <input class="form-control" name="fname" id="fname" type="text" placeholder="Enter First Name" required />
            </div>
            <div class="flex-fill">
              <input class="form-control" name="lname" id="lname" type="text" placeholder="Enter Last Name" required />
            </div>
          </div>

          <!-- age DOB -->
          <div class="mb-3 d-flex align-items-end gap-3">
            <div style="max-width: 200px; flex-shrink: 0;">
              <input class="form-control form-control-sm" name="dob" id="dob" type="date" required onchange="calculateAge()" />
            </div>
            <div style="flex: 1;">
              <input class="form-control form-control-sm" id="age" name="age" type="number" placeholder="Age will be calculated" readonly />
            </div>
          </div>

          <!-- Email -->
          <div class="mb-3">
            <input class="form-control" id="email" name="email" type="email" placeholder="Enter Email Address" required />
          </div>

          <!-- Password -->
          <div class="mb-3">
            <input class="form-control" id="password" name="pass" type="password" placeholder="Enter Password" required />
          </div>

          <!-- Confirm Password -->
          <div class="mb-4">
            <input class="form-control" id="cpassword" type="password" placeholder="Confirm Password" required />
          </div>

          <!-- Signin Button -->
          <div class="d-grid">
            <input class="btn btn-primary" type="submit" id="signin" value="Signin" disabled>
          </div>

          <!-- Already have account -->
          <h6 class="text-center mt-3">
            Already have an account ? 
            <a class="text-primary" href="{% url 'home' %}">Login</a>
          </h6>

          <!-- Error Feedback -->
          <div class="invalid-feedback mt-2" id="emailError" style="display: none;">Valid email is required.</div>
          <small id="ageError" style="color: red; display: none;">You must be at least 18 years old to sign up.</small>
        </div>
      </div>
    </div>
  </form>
  <!-- Typing Box -->
  <div id="location-info">
    <span id="typed-text"></span><span id="cursor">|</span>
  </div>

  {% if messages and signup_page %}
  <div id="custom-tooltip" style="
    position: fixed;
    top: 20px;
    left: 65%;
    background: #333;
    color: #fff;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 14px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
    z-index: 9999;
  ">
    {% for message in messages %}
      {{ message }}
    {% endfor %}
  </div>

  <script>
    const tooltip = document.getElementById('custom-tooltip');
    tooltip.style.opacity = '1';
    tooltip.style.pointerEvents = 'auto';

    setTimeout(() => {
      tooltip.style.opacity = '0';
      tooltip.style.pointerEvents = 'none';
    }, 4000);
  </script>
  {% endif %}

  <!-- Bootstrap core JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Core theme JS -->
  <script src="{% static 'js/scripts.js' %}"></script>

  <!-- SB Forms JS -->
  <script src="https://cdn.startbootstrap.com/sb-forms-latest.js"></script>

  <!-- Typing Script -->
  <script>
    const locationText = `Welcome! You can sign up using this form.\nPlease provide correct details to proceed.\n__italic__Note: Only users approved by the admin\nwill be able to login. __enditalic__\n\nWeâ€™re excited to have you onboard!`;
    const typedTextEl = document.getElementById("typed-text");
    const cursorEl = document.getElementById("cursor");

    function typeLocationText(text, delay = 60) {
      const segments = [];
      let buffer = '';
      let mode = 'normal';

      for (let i = 0; i < text.length;) {
        if (text.startsWith('__italic__', i)) {
          if (buffer) segments.push({ text: buffer, type: mode });
          buffer = '';
          mode = 'italic';
          i += 10;
        } else if (text.startsWith('__enditalic__', i)) {
          if (buffer) segments.push({ text: buffer, type: mode });
          buffer = '';
          mode = 'normal';
          i += 12;
        } else {
          buffer += text[i];
          i++;
        }
      }

      if (buffer) segments.push({ text: buffer, type: mode });

      // Now type out each character
      let segIndex = 0, charIndex = 0;
      typedTextEl.innerHTML = '';

      function typeNext() {
        if (segIndex >= segments.length) return;

        const seg = segments[segIndex];
        const container = document.createElement(seg.type === 'italic' ? 'em' : 'span');

        if (!container.textContent) typedTextEl.appendChild(container);

        const char = seg.text[charIndex];
        if (char === '\n') {
          typedTextEl.appendChild(document.createElement('br'));
        } else {
          container.textContent += char;
        }

        charIndex++;

        if (charIndex >= seg.text.length) {
          segIndex++;
          charIndex = 0;
        }

        setTimeout(typeNext, delay);
      }

      typeNext();
    }

    window.addEventListener("DOMContentLoaded", () => {
      typeLocationText(locationText);
    });
  </script>

  <!-- Signup Logic -->
  <script>
    const signupBtn = document.getElementById("signin");
    const email = document.getElementById("email");
    const password = document.getElementById("password");
    const cpassword = document.getElementById("cpassword");
    const emailError = document.getElementById("emailError");
    const dob = document.getElementById("dob");
    const age = document.getElementById("age");
    const ageError = document.getElementById("ageError");

    function calculateAge() {
      const dobValue = dob.value;
      if (dobValue) {
        const birthDate = new Date(dobValue);
        const today = new Date();
        let calculatedAge = today.getFullYear() - birthDate.getFullYear();
        const m = today.getMonth() - birthDate.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
          calculatedAge--;
        }
        age.value = calculatedAge;
      } else {
        age.value = "";
      }
      validateSignup();
    }

    function validateSignup() {
      const validEmail = email.value.includes("@");
      const pwMatch = password.value && password.value === cpassword.value;
      const dobSelected = dob.value !== "";
      const ageFilled = age.value !== "";
      const isOldEnough = parseInt(age.value) >= 18;

      emailError.style.display = validEmail ? "none" : "block";

      if (!isOldEnough && ageFilled) {
        ageError.style.display = "block";
      } else {
        ageError.style.display = "none";
      }

      signupBtn.disabled = !(validEmail && pwMatch && dobSelected && ageFilled && isOldEnough);
    }

    email.addEventListener("input", validateSignup);
    password.addEventListener("input", validateSignup);
    cpassword.addEventListener("input", validateSignup);
    dob.addEventListener("change", calculateAge);
    
    // Submit handler
        // document.getElementById("SignupForm").addEventListener("submit", (e) => {
        //   e.preventDefault();
        //   console.log("Signup:", {
        //     fname: document.getElementById("fname").value,
        //     lname: document.getElementById("lname").value,
        //     email: email.value,
        //     dob: dob.value,
        //     age: age.value,
        //     password: password.value,
        //   });
        // });
        
    window.addEventListener("DOMContentLoaded", () => {
      const content = document.querySelector(".fade-in");
      if (content) {
        setTimeout(() => {
          content.classList.add("fade-in");
        }, 600);
      }
    });
  </script>
</div>
{% endblock %}
</body>
</html>
