{% extends 'admins.html' %}
{% load static %}

{% block title %}Contact Messages{% endblock %}

{% block content %}
<div class="content-section mt-2" id="contact">
  <header class="mb-6">
    <h1 class="text-3xl font-bold tracking-widest">Contact Messages</h1>
    <p class="text-cyan-400">
      Admin can view the messages submitted through the contact form.
    </p>
  </header>

  <!-- Table -->
  <div class="bg-black/60 rounded-xl p-6 shadow-lg backdrop-blur overflow-x-auto">

    <!-- Filter and Search Controls -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-4">
      <div class="flex items-center space-x-2 text-white">
        <select id="entriesSelect" class="bg-gray-800 text-white rounded px-2 py-1">
          <option value="5" selected>5</option>
          <option value="10">10</option>
          <option value="15">15</option>
          <option value="20">20</option>
          <option value="all">All</option>
        </select>
      </div>
      <div class="flex items-center space-x-3">
        <input type="text" id="searchInput" placeholder="Search..." class="px-3 py-2 rounded focus:outline-none focus:ring-2 text-black" />
        <button id="deleteAllBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
          <i class="fa-solid fa-trash-can"></i>
        </button>
      </div>
    </div>

    <!-- Table -->
    <table class="min-w-full divide-y divide-gray-700 text-white rounded-xl">
      <thead class="bg-gray-800">
        <tr>
          <th class="px-6 py-3 text-center text-left text-xs font-medium uppercase tracking-wider">Name</th>
          <th class="px-6 py-3 text-center text-left text-xs font-medium uppercase tracking-wider">Email</th>
          <th class="px-6 py-3 text-center text-left text-xs font-medium uppercase tracking-wider">Phone No.</th>
          <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Message</th>
        </tr>
      </thead>
      <tbody id="tableBody" class="bg-black/50 divide-y divide-gray-700">
        <!-- Data will be loaded dynamically -->
      </tbody>
    </table>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const searchInput = document.getElementById("searchInput");
  const entriesSelect = document.getElementById("entriesSelect");
  const tableBody = document.getElementById("tableBody");
  const deleteAllBtn = document.getElementById("deleteAllBtn");

  // Function to fetch and display data
  function fetchMessages() {
    fetch("{% url 'contactus' %}", {
      headers: { "X-Requested-With": "XMLHttpRequest" }
    })
    .then(res => res.json())
    .then(data => renderTable(data));
  }

  // Function to render table based on search and entry limit
  function renderTable(data) {
    const searchTerm = searchInput.value.toLowerCase();
    const limit = entriesSelect.value === "all" ? data.length : parseInt(entriesSelect.value);
    let html = '';
    let shown = 0;

    for (let item of data) {
      const rowText = `${item.Cname} ${item.Cemail} ${item.Cphone} ${item.Cmessage}`.toLowerCase();
      if (rowText.includes(searchTerm) && shown < limit) {
        html += `
          <tr>
            <td class="px-2 py-3 text-center">${item.Cname}</td>
            <td class="px-2 py-3 text-center">${item.Cemail}</td>
            <td class="px-2 py-3 text-center">${item.Cphone}</td>
            <td class="px-2 py-3 text-left whitespace-pre-line">${item.Cmessage}</td>
          </tr>`;
        shown++;
      }
    }

    if (shown === 0) {
      html = `<tr><td colspan="4" class="py-3 text-center text-gray-400">No contact messages found.</td></tr>`;
    }

    tableBody.innerHTML = html;
  }

  // Delete all messages via AJAX
  deleteAllBtn.addEventListener("click", function () {
    if (!confirm("Are you sure you want to delete all messages?")) return;

    fetch("{% url 'delete_all_contacts' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "X-Requested-With": "XMLHttpRequest"
      }
    })
    .then(res => res.json())
    .then(response => {
      if (response.success) {
        fetchMessages(); // Refresh table
      }
    });
  });

  searchInput.addEventListener("input", fetchMessages);
  entriesSelect.addEventListener("change", fetchMessages);

  fetchMessages(); // Load on first page open
});
</script>
{% endblock %}
