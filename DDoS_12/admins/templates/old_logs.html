{% extends 'admins.html' %}
{% load static %}

{% block title %}Activity Logs{% endblock %}

{% block content %}
<div class="content-section mt-2" id="logs">
  <header class="mb-6">
    <h1 class="text-3xl font-bold tracking-widest">Activity Logs</h1>
    <p class="text-cyan-400">Admin can view the logs of all users.</p>
  </header>

  <div class="bg-black/60 rounded-xl p-6 shadow-lg backdrop-blur overflow-x-auto">

    <!-- Filters and Search -->
    <div class="flex flex-col gap-4 mb-4">
      <!-- Top Filters Row -->
      <div class="flex flex-col lg:flex-row justify-between items-center gap-4">
        <div class="flex flex-wrap items-center gap-4">
          <select id="entriesSelect" class="bg-gray-800 text-white rounded px-2 py-1">
            <option value="1" selected>1</option>
            <option value="3">3</option>
            <option value="5">5</option>
            <option value="7">7</option>
            <option value="9">9</option>
            <option value="all">All</option>
          </select>

          <!-- Sort Order -->
          <select id="sortOrder" class="bg-gray-800 text-white rounded px-2 py-1">
            <option value="desc" selected>Newest First</option>
            <option value="asc">Oldest First</option>
          </select>

          <!-- Feature Filter -->
          <select id="featureFilter" class="bg-gray-800 text-white rounded px-2 py-1">
            <option value="all">All Features</option>
            <option value="User Logged-in">Login</option>
            <option value="User Updated Profile Data">Profile Update</option>
            <option value="Visited User Home">User Home</option>
            <option value="Visited Capture Traffic Page">Capture Traffic</option>
            <option value="Charts">Charts</option>
            <option value="Visited CSV File Editor">CSV Editor</option>
            <option value="Visited Attack-Analysis Report">DDoS Report</option>
            <option value="Visited Advanced-Analysis Report Using AI">DDoS AI Report</option>
            <option value="Visited Dos & DDos Home Page">DDoS Home</option>
            <option value="Visited Manual Detection">Manual</option>
            <option value="Visited Real-Time Detection">Real-Time</option>
          </select>

          <!-- User Filter -->
          <select id="userFilter" class="bg-gray-800 text-white rounded px-2 py-1">
            <option value="all">All Emails</option>
            {% for log in logs %}
              <option value="{{ log.User_key.Email }}">{{ log.User_key.Email }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Search and Delete -->
        <div class="flex flex-wrap items-center gap-2">
          <input type="text" id="searchInput" placeholder="Search..."
            class="px-3 py-2 rounded text-black focus:outline-none focus:ring-2" />
          <button id="deleteAllBtn"
            class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition duration-200">
            <i class="fa-solid fa-trash-can"></i>
          </button>
        </div>
      </div>

</div>


    <!-- Logs Table -->
    <table id="logsTable" class="min-w-full divide-y divide-gray-700 text-white rounded-xl">
      <thead class="bg-gray-800">
        <tr>
          <!-- <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">User</th> -->
          <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Activity
            <select id="activityLimit" class="ml-2 bg-gray-800 text-white rounded px-1 py-0.5 text-xs">
              <option value="1">1</option>
              <option value="3">3</option>
              <option value="5">5</option>
              <option value="all" selected>All</option>
            </select>
          </th>
          <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Details</th>
        </tr>
      </thead>
      <tbody id="tableBody" class="bg-black/50 divide-y divide-gray-700">
        {% for log in logs %}
        <tr data-user="{{ log.User_key.Email }}">
          <!-- <td class="px-4 py-3 font-semibold">
            {{ log.User_key.Fname }} {{ log.User_key.Lname }}<br>
            <small class="text-gray-400">{{ log.User_key.Email }}</small>
          </td> -->
          <td class="px-4 py-3 space-y-1 activity-cell">
            {% if log.User_login_time %}<div class="activity-item"><span class="text-uppercase">{{ log.User_key.Fname }} {{ log.User_key.Lname }} ,</span> {{ log.User_login }} <span class="text-xs text-gray-400">({{ log.User_login_time }})</span></div>{% endif %}
            {% if log.User_settings_time %}<div class="activity-item"><span class="text-uppercase">{{ log.User_key.Fname }} {{ log.User_key.Lname }} ,</span> {{ log.User_settings }} <span class="text-xs text-gray-400">({{ log.User_settings_time }})</span></div>{% endif %}
            {% if log.User_home_time %}<div class="activity-item"><span class="text-uppercase">{{ log.User_key.Fname }} {{ log.User_key.Lname }} ,</span> {{ log.User_home }} <span class="text-xs text-gray-400">({{ log.User_home_time }})</span></div>{% endif %}
            {% if log.Capture_traffic_time %}<div class="activity-item"><span class="text-uppercase">{{ log.User_key.Fname }} {{ log.User_key.Lname }} ,</span> {{ log.Capture_traffic }} <span class="text-xs text-gray-400">({{ log.Capture_traffic_time }})</span></div>{% endif %}
            {% if log.Charts_time %}<div class="activity-item"><span class="text-uppercase">{{ log.User_key.Fname }} {{ log.User_key.Lname }} ,</span> {{ log.Charts }} <span class="text-xs text-gray-400">({{ log.Charts_time }})</span></div>{% endif %}
            {% if log.Csv_file_editor_time %}<div class="activity-item"><span class="text-uppercase">{{ log.User_key.Fname }} {{ log.User_key.Lname }} ,</span> {{ log.Csv_file_editor }} <span class="text-xs text-gray-400">({{ log.Csv_file_editor_time }})</span></div>{% endif %}
            {% if log.RealTime_Traffic_time %}<div class="activity-item"><span class="text-uppercase">{{ log.User_key.Fname }} {{ log.User_key.Lname }} ,</span> {{ log.RealTime_Traffic }} <span class="text-xs text-gray-400">({{ log.RealTime_Traffic_time }})</span></div>{% endif %}
            {% if log.DDOS_Home_time %}<div class="activity-item"><span class="text-uppercase">{{ log.User_key.Fname }} {{ log.User_key.Lname }} ,</span> {{ log.DDOS_Home }} <span class="text-xs text-gray-400">({{ log.DDOS_Home_time }})</span></div>{% endif %}
            {% if log.Manual_detection_time %}<div class="activity-item"><span class="text-uppercase">{{ log.User_key.Fname }} {{ log.User_key.Lname }} ,</span> {{ log.Manual_detection }} <span class="text-xs text-gray-400">({{ log.Manual_detection_time }})</span></div>{% endif %}
            {% if log.DDOS_Report_time %}<div class="activity-item">{{ log.DDOS_Report }} <span class="text-xs text-gray-400">({{ log.DDOS_Report_time }})</span></div>{% endif %}
            {% if log.DDOS_AI_Report_time %}<div class="activity-item"><span class="text-uppercase">{{ log.User_key.Fname }} {{ log.User_key.Lname }} ,</span> {{ log.DDOS_AI_Report }} <span class="text-xs text-gray-400">({{ log.DDOS_AI_Report_time }})</span></div>{% endif %}
            {% if log.User_logout_time %}<div class="activity-item"><span class="text-uppercase">{{ log.User_key.Fname }} {{ log.User_key.Lname }} ,</span> {{ log.User_logout }} <span class="text-xs text-gray-400">({{ log.User_logout_time }})</span></div>{% endif %}
          </td>
          <td class="px-4 py-3">
            <button class="toggle-details bg-gray-900 hover:bg-gray-800 text-white px-3 py-1 rounded flex items-center gap-1">
              <span>View</span>
              <svg class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
            </button>
            <div class="user-details transition-all duration-300 ease-in-out transform scale-y-0 origin-top overflow-hidden mt-2 text-sm bg-gray-900 rounded p-2">
              <div><strong>DOB:</strong> {{ log.User_key.Dob }}</div>
              <div><strong>Age:</strong> {{ log.User_key.Age }}</div>
              <div><strong>Email:</strong> {{ log.User_key.Email }}</div>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="3" class="text-center py-4 text-gray-400">No logs found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const searchInput = document.getElementById("searchInput");
  const entriesSelect = document.getElementById("entriesSelect");
  const userFilter = document.getElementById("userFilter");
  const featureFilter = document.getElementById("featureFilter");
  const activityLimit = document.getElementById("activityLimit");
  const deleteAllBtn = document.getElementById("deleteAllBtn");
  const sortOrder = document.getElementById("sortOrder"); // new

  const rows = Array.from(document.querySelectorAll("#tableBody tr"));

  // Helper: Get latest timestamp in a row
  function getLatestActivityTime(row) {
    const timestamps = Array.from(row.querySelectorAll(".activity-item span.text-gray-400"))
      .map(span => {
        const raw = span.textContent.replace(/[()]/g, '').trim();
        const parsed = Date.parse(raw);
        return isNaN(parsed) ? 0 : parsed;
      });
    return timestamps.length ? Math.max(...timestamps) : 0;
  }

  function updateTable() {
    const searchTerm = searchInput.value.toLowerCase();
    const selectedEmail = userFilter.value;
    const selectedFeature = featureFilter.value;
    const limit = entriesSelect.value === "all" ? Infinity : parseInt(entriesSelect.value);
    const activityCount = activityLimit.value === "all" ? Infinity : parseInt(activityLimit.value);
    const sortDirection = sortOrder?.value || "desc";

    // Filter
    let filtered = rows.filter(row => {
      const text = row.innerText.toLowerCase();
      const email = row.dataset.user;
      const featureMatch = selectedFeature === "all" || text.includes(selectedFeature.toLowerCase());
      return text.includes(searchTerm) && (selectedEmail === "all" || email === selectedEmail) && featureMatch;
    });

    // Sort
    filtered.sort((a, b) => {
      const timeA = getLatestActivityTime(a);
      const timeB = getLatestActivityTime(b);
      return sortDirection === "asc" ? timeA - timeB : timeB - timeA;
    });

    // Show
    rows.forEach(row => row.style.display = "none");
    const toShow = filtered.slice(0, limit);
    toShow.forEach(row => {
      row.style.display = "";
      const activities = row.querySelectorAll(".activity-item");
      activities.forEach((el, i) => el.style.display = i < activityCount ? "" : "none");
    });
  }

  // Bind events
  searchInput.addEventListener("input", updateTable);
  entriesSelect.addEventListener("change", updateTable);
  userFilter.addEventListener("change", updateTable);
  featureFilter.addEventListener("change", updateTable);
  activityLimit.addEventListener("change", updateTable);
  if (sortOrder) sortOrder.addEventListener("change", updateTable);

  updateTable();

  // Delete all logs
  deleteAllBtn.addEventListener("click", () => {
    if (confirm("Are you sure you want to delete all logs?")) {
      fetch("{% url 'delete_all_logs' %}", {
        method: "POST",
        headers: { "X-CSRFToken": "{{ csrf_token }}" }
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) location.reload();
        else alert("Failed to delete logs.");
      });
    }
  });

  // Toggle expandable rows
  document.querySelectorAll('.toggle-details').forEach(button => {
    button.addEventListener('click', function () {
      const details = this.nextElementSibling;
      const icon = this.querySelector('svg');
      details.classList.toggle('scale-y-0');
      icon.classList.toggle('rotate-180');
    });
  });
});
</script>

{% endblock %}
